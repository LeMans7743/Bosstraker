<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>BOSS Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4">
  <h1 class="text-2xl font-bold mb-4">BOSS Tracker</h1>

  <!-- 追蹤列表 -->
  <div id="bossList" class="space-y-2 mb-6"></div>

  <!-- 新增 BOSS 區塊 -->
  <div class="bg-gray-800 p-4 rounded-lg shadow-md space-y-2">
    <h2 class="text-xl font-semibold">新增 BOSS</h2>
    <select id="bossName" class="text-black p-1 rounded">
      <option value="雪毛怪人">雪毛怪人</option>
      <option value="咕咕鐘">咕咕鐘</option>
      <option value="測試王">測試王</option>
    </select>
    <input id="channel" type="number" placeholder="頻道" class="text-black p-1 rounded w-20">
    <button onclick="addBoss()" class="bg-blue-500 px-2 py-1 rounded">新增</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-app.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-messaging.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC6mq6ukjzpNmaIy5dLewwHqrJTTpaB2jA",
      authDomain: "bosstrackerweb.firebaseapp.com",
      projectId: "bosstrackerweb",
      storageBucket: "bosstrackerweb.firebasestorage.app",
      messagingSenderId: "620047423570",
      appId: "1:620047423570:web:2d1881a9edc1a1b6cba78b"
    };
    const app = initializeApp(firebaseConfig);
    const messaging = getMessaging(app);

    async function requestPermission() {
      if(Notification.permission !== "granted"){
        await Notification.requestPermission();
      }
      try {
        const token = await getToken(messaging, { vapidKey: "BBQv_vF-t2r8ALxzDZj9xcSlsrJbJ73nI19w6YeLZVdoLERxBJ88NI8pucgS9xN2_KO-osGLJ-oHLpLNcYZbEQc" });
        console.log("FCM token:", token);
      } catch(e){ console.log(e); }
    }
    requestPermission();

    // BOSS 重生時間表 (單位: 分鐘)
    const BOSS_RESPAWN = {
      '雪毛怪人': { min: 45, max: 68 },
      '咕咕鐘': { min: 68, max: 90 },
      '測試王': { min: 5/60, max: 10/60 } // 5–10 秒
    };

    let bossTrackers = [];

    function sendNotification(title, body) {
      if(Notification.permission==="granted"){
        navigator.serviceWorker.getRegistration().then(reg=>{
          if(reg){
            reg.showNotification(title,{body});
          }
        });
      }
    }

    function addBoss() {
      const name = document.getElementById('bossName').value;
      const channel = document.getElementById('channel').value || "?";
      const respawn = BOSS_RESPAWN[name];

      const deathTime = new Date();
      const minRespawn = new Date(deathTime.getTime() + respawn.min*60000);
      const maxRespawn = new Date(deathTime.getTime() + respawn.max*60000);

      const id = Date.now();
      bossTrackers.push({ id, name, channel, deathTime, minRespawn, maxRespawn });
      renderList();
    }

    function markKilled(id) {
      const tracker = bossTrackers.find(b => b.id === id);
      if(tracker){
        const respawn = BOSS_RESPAWN[tracker.name];
        tracker.deathTime = new Date();
        tracker.minRespawn = new Date(tracker.deathTime.getTime() + respawn.min*60000);
        tracker.maxRespawn = new Date(tracker.deathTime.getTime() + respawn.max*60000);
      }
    }

    function deleteBoss(id) {
      bossTrackers = bossTrackers.filter(b => b.id !== id);
      renderList();
    }

    function renderList() {
      const container = document.getElementById('bossList');
      container.innerHTML = '';
      bossTrackers.sort((a,b)=>a.minRespawn-b.minRespawn);

      bossTrackers.forEach(boss=>{
        const row = document.createElement('div');
        row.className = "bg-gray-800 p-2 rounded flex items-center justify-between text-sm";

        const info = document.createElement('div');
        info.innerHTML = `
          <span class="font-bold">${boss.name}</span>
          | 頻道 ${boss.channel}
          | 最快重生: <span id="min-${boss.id}"></span>
          | 最慢重生: <span id="max-${boss.id}"></span>
          | <span id="status-${boss.id}" class="font-bold">狀態: 倒數中</span>
        `;

        const buttons = document.createElement('div');
        buttons.className = "space-x-2";
        buttons.innerHTML = `
          <button onclick="markKilled(${boss.id})" class="bg-yellow-500 px-2 py-1 rounded">已擊殺</button>
          <button onclick="deleteBoss(${boss.id})" class="bg-red-500 px-2 py-1 rounded">刪除</button>
        `;

        row.appendChild(info);
        row.appendChild(buttons);
        container.appendChild(row);

        startCountdown(boss);
      });
    }

    function startCountdown(boss) {
      const minEl = document.getElementById(`min-${boss.id}`);
      const maxEl = document.getElementById(`max-${boss.id}`);
      const statusEl = document.getElementById(`status-${boss.id}`);

      function update() {
        const now = new Date();
        const diffMin = Math.floor((boss.minRespawn - now) / 1000);
        const diffMax = Math.floor((boss.maxRespawn - now) / 1000);

        if(diffMax <=0){
          clearInterval(timer);
          statusEl.textContent = "狀態: 已脫離掌握";
          statusEl.classList.remove("text-green-600");
          statusEl.classList.add("text-red-600");
          minEl.textContent = "-";
          maxEl.textContent = "-";
        } else {
          if(diffMin > 0){
            const m=Math.floor(diffMin/60), s=diffMin%60;
            minEl.textContent=`${m}分${s}秒`;
            statusEl.textContent="狀態: 倒數中";
            statusEl.classList.remove("text-green-600","text-red-600");
          } else {
            minEl.textContent="已過";
            statusEl.textContent="狀態: 重生中";
            statusEl.classList.add("text-green-600");
            statusEl.classList.remove("text-red-600");
            // 最短時間到通知
            sendNotification(`${boss.name}重生通知`, `${boss.name}在頻道${boss.channel}即將重生`);
          }

          if(diffMax <=60){
            // 最長時間前1分鐘通知
            sendNotification(`${boss.name}重生即將結束`, `${boss.name}在頻道${boss.channel}即將重生完畢`);
          }

          const m2=Math.floor(diffMax/60), s2=diffMax%60;
          maxEl.textContent=`${m2}分${s2}秒`;
        }
      }

      update();
      const timer = setInterval(update,1000);
    }
  </script>
</body>
</html>
